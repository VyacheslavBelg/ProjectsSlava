@page "/bioage"
@using BioAgeFrontend.Models
@inject BioAgeFrontend.Services.ApiService Api

<div class="container d-flex justify-content-center align-items-center flex-column mt-5 mb-5">
    <div class="card shadow-sm p-4" style="max-width: 450px; width: 100%;">
        <h3 class="text-center mb-4" style="color: var(--main-color);">Расчёт биологического возраста</h3>

        <EditForm Model="@request" OnValidSubmit="@Calculate">
            <DataAnnotationsValidator />
            <ValidationSummary />

            <div class="mb-3">
                <label class="form-label">Имя</label>
                <InputText @bind-Value="request.Name" class="form-control" />
                <ValidationMessage For="@(() => request.Name)" />
            </div>

            <div class="mb-3">
                <label class="form-label">Возраст</label>
                <InputNumber @bind-Value="request.ChronologicalAge" class="form-control" />
                <ValidationMessage For="@(() => request.ChronologicalAge)" />
            </div>

            <div class="mb-3">
                <label class="form-label">Рост (см)</label>
                <InputNumber @bind-Value="request.Height" class="form-control" />
                <ValidationMessage For="@(() => request.Height)" />
            </div>

            <div class="mb-3">
                <label class="form-label">Вес (кг)</label>
                <InputNumber @bind-Value="request.Weight" class="form-control" />
                <ValidationMessage For="@(() => request.Weight)" />
            </div>

            <div class="mb-3">
                <label class="form-label">Талия (см)</label>
                <InputNumber @bind-Value="request.Waist" class="form-control" />
                <ValidationMessage For="@(() => request.Waist)" />
            </div>

            <div class="mb-3">
                <label class="form-label">Шея (см)</label>
                <InputNumber @bind-Value="request.Neck" class="form-control" />
                <ValidationMessage For="@(() => request.Neck)" />
            </div>

            <div class="form-check mb-3">
                <InputCheckbox @bind-Value="request.IsFemale" class="form-check-input" id="femaleCheck" />
                <label class="form-check-label" for="femaleCheck">Женщина</label>
            </div>

            @if (request.IsFemale)
            {
                <div class="mb-3">
                    <label class="form-label">Бёдра (см)</label>
                    <InputNumber @bind-Value="request.Hips" class="form-control" />
                    <ValidationMessage For="@(() => request.Hips)" />
                </div>
            }

            <div class="text-center mt-4">
                <button type="submit" class="btn btn-custom px-5 py-2">Рассчитать</button>
            </div>
        </EditForm>
    </div>
</div>


@if (showModal)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header" style="background-color: var(--main-color); color: white;">
                    <h5 class="modal-title">Результаты расчёта</h5>
                    <button type="button" class="btn-close btn-close-white" @onclick="CloseModal"></button>
                </div>
                <div class="modal-body">
                    @if (result != null)
                    {
                        <p><b>Имя:</b> @result.Name</p>
                        <p><b>Биологический возраст:</b> 
                            <span style="color: var(--main-color); font-weight: 600;">@result.BiologicalAge</span>
                        </p>
                        <p><b>Статус здоровья:</b> 
                            <span style="color: var(--accent-color); font-weight: 600;">@result.HealthStatus</span>
                        </p>
                        <p><b>Разница:</b> @(result.AgeDifference > 0 ? "+" : "")@result.AgeDifference лет</p>
                    }
                </div>
                <div class="modal-footer">
                    <button class="btn btn-custom" @onclick="CloseModal">Закрыть</button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private CalculationRequest request = new();
    private CalculationResponse? result;
    private bool showModal = false;

    private async Task Calculate()
    {
        // Простейшая ручная валидация на отрицательные значения
        if (request.Height <= 0 || request.Weight <= 0 || request.Waist <= 0 || request.Neck <= 0 ||
            (request.IsFemale && request.Hips.HasValue && request.Hips.Value <= 0))
        {
            await ShowValidationError("Все значения должны быть положительными числами.");
            return;
        }

        if (request.ChronologicalAge <= 0)
        {
            await ShowValidationError("Возраст должен быть больше 0.");
            return;
        }

        try
        {
            result = await Api.CalculateAsync(request);
            showModal = true;
        }
        catch (Exception ex)
        {
            await ShowValidationError("Ошибка при расчёте: " + ex.Message);
        }
    }

    private void CloseModal()
    {
        showModal = false;
        result = null;
    }

    // Показывает всплывающее окно с ошибкой валидации
    private async Task ShowValidationError(string message)
    {
        await JS.InvokeVoidAsync("alert", message);
    }

    [Inject]
    private IJSRuntime JS { get; set; } = default!;
}
